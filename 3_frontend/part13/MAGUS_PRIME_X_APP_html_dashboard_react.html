<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAGUS PRIME X - React Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #101820;
        color: #fff;
        padding: 20px;
      }
      .container {
        max-width: 1000px;
        margin: auto;
      }
      h1 {
        color: #ffd700;
      }
      .stats-box {
        background: #1e1e2f;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
      }
      .progress-bar {
        background: #444;
        border-radius: 8px;
        overflow: hidden;
      }
      .progress {
        height: 20px;
        background: #00ff99;
        width: 0%;
        transition: width 0.5s ease-in-out;
      }

      /* Progress width classes instead of inline styles */
      .progress-0 {
        width: 0%;
      }
      .progress-10 {
        width: 10%;
      }
      .progress-20 {
        width: 20%;
      }
      .progress-30 {
        width: 30%;
      }
      .progress-40 {
        width: 40%;
      }
      .progress-50 {
        width: 50%;
      }
      .progress-60 {
        width: 60%;
      }
      .progress-70 {
        width: 70%;
      }
      .progress-80 {
        width: 80%;
      }
      .progress-90 {
        width: 90%;
      }
      .progress-100 {
        width: 100%;
      }

      /* CSS custom properties for progress value */
      :root {
        --progress-value: 0%;
      }

      .progress-custom {
        width: var(--progress-value);
      }
    </style>
  </head>
  <body>
    <div id="app-root"></div>

    <!-- Store Flask template variables in global state before React processing -->
    <script>
      // Pre-parse Flask template variables to avoid syntax errors in React
      window.dashboardData = {
        timestamps: JSON.parse("{{ timestamps|safe }}"),
        balances: JSON.parse("{{ balances|safe }}"),
        balance: "{{ balance }}",
        progress: "{{ progress }}",
      };
    </script>

    <script type="text/babel">
      // React component for the dashboard
      function Dashboard(props) {
        const { balance, progress, timestamps, balances } = props;

        // Calculate the appropriate progress class (rounded to nearest 10)
        const progressClass = `progress-${Math.floor(progress / 10) * 10}`;

        // Set up the custom property for precise progress
        React.useEffect(() => {
          document.documentElement.style.setProperty(
            "--progress-value",
            `${progress}%`,
          );
        }, [progress]);

        // Set up Chart.js
        React.useEffect(() => {
          const ctx = document.getElementById("equityChart").getContext("2d");
          const equityChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: timestamps,
              datasets: [
                {
                  label: "Balance Over Time (AED)",
                  data: balances,
                  borderColor: "#00ffcc",
                  fill: false,
                  tension: 0.3,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  display: true,
                  title: {
                    display: true,
                    text: "Time",
                  },
                  ticks: {
                    color: "#aaa",
                  },
                },
                y: {
                  display: true,
                  title: {
                    display: true,
                    text: "Balance (AED)",
                  },
                  ticks: {
                    color: "#aaa",
                  },
                },
              },
            },
          });

          // Clean up function to destroy chart on unmount
          return () => {
            equityChart.destroy();
          };
        }, [timestamps, balances]);

        return (
          <div className="container">
            <h1>ðŸ“Š MAGUS PRIME X Dashboard</h1>

            <div className="stats-box">
              <h3>ðŸ’¼ Current Balance: {balance} AED</h3>
              <h3>ðŸŽ¯ Growth Progress: {progress}%</h3>
              <div className="progress-bar">
                {/* Use class-based styling instead of inline styles */}
                <div className={`progress progress-custom`}></div>
              </div>
            </div>

            <div className="stats-box">
              <h3>ðŸ“ˆ Equity Curve</h3>
              <canvas id="equityChart" height="100"></canvas>
            </div>
          </div>
        );
      }

      // Use the pre-parsed data from the global state
      // This avoids syntax errors with Flask template variables
      const { timestamps, balances, balance, progress } = window.dashboardData;

      // Render the React component
      ReactDOM.render(
        <Dashboard
          balance={balance}
          progress={progress}
          timestamps={timestamps}
          balances={balances}
        />,
        document.getElementById("app-root"),
      );
    </script>
  </body>
</html>
